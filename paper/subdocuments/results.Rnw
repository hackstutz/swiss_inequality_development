%%%-------------------------------------------------%%%
%%% Sub document results %%%
%%%-------------------------------------------------%%%

\section{Results}

% Brauchen wir glaubs nicht mehr
%\textcolor{red}{Gesamtschweizer Grafik (mit imputierten Daten) einmal eine Linie mit Bias, einmal ohne
%Kantonsweise Grafiken
%Kuznets / U-Turn, Test der Hypothesen mit den final Daten. Der link zwischen rein deskriptiv  und Theorie plus Modell ist aktuell noch ein krasser Drahtseilakt...}

% Der Übersicht halber habe ich hier die Titel hier analog zum "Struktur-Issue" auf git gesetzt

\subsection{Defining income}


\emph{Gini coefficients for taxable income, income before deductions and taxable income after tax}

<<setup_gini_data>>=
library(foreign)
library(ggplot2)
df <- read.csv("../../data/ginis_und_perzentile_normal.csv",sep="\t")
df$zeros <- df$null_norm/df$cpop # i only use normal cases here
@

<<different_ginis>>=
df$G_reink[df$G_reink==1]<-NA
df$G_taxed[df$G_taxed==1]<-NA
library(reshape)
number_ticks <- function(n) {function(limits) pretty(limits, n)}
dflong <- melt(df[,c("G_steink","G_reink","G_taxed","kanton","steuerperiode")], id=c("kanton","steuerperiode"))
names(dflong)[3]<-"Type"
names(dflong)[4]<-"Gini"
levels(dflong$Type)<-c("taxable income","income before deductions","taxable income after tax")
ggplot(dflong[dflong$kanton=="CH",], aes(x=steuerperiode,y=Gini,shape=Type))+
  scale_y_continuous(limits=c(0.18,0.4))+
  scale_x_continuous(limits=c(1982,2012),breaks=number_ticks(10)) +
  geom_point(aes(shape=Type),size=3)+
  geom_line(data=dflong[dflong$kanton=="CH",],aes(linetype=Type))+
  theme_bw()+
  xlab("tax period")
#ggplot(dflong, aes(x=steuerperiode,y=Gini,colour=Type))+geom_line()+facet_wrap(~kanton)+theme_bw()+xlab("tax period")
@

\subsection{Statistical units}

<<setup_data>>=
library(dplyr, quietly=TRUE, warn.conflicts = FALSE)
# Ohne Nuller
bd <- read.csv("../../data/data_Schweiz.csv", header=TRUE,sep=";")
#Veranlagungsperiode -> Jahre
bd$Jahr <- as.numeric(substr(bd$Veranlagungsperiode,1,4))
bd$Jahr[nchar(as.character(bd$Veranlagungsperiode))>4] <- bd$Jahr[nchar(as.character(bd$Veranlagungsperiode))>4] - 2
bd<-bd %.% 
  filter(Einheit=="Total")
bd<-subset(bd,Jahr<1995 | Jahr >2002)
bd.long<-reshape(bd,
varying = c("gini_reink","gini_reinka"),
v.names = "Gini",
timevar = "inc_def",
times = c("Net income (only taxed)","Equivalised net income (only taxed)"),
direction ="long")
# mit Nuller
bd.0 <- read.csv("../../data/data_Schweiz_mitNull.csv", header=TRUE,sep=";")
#Veranlagungsperiode -> Jahre
bd.0$Jahr <- as.numeric(substr(bd.0$Veranlagungsperiode,1,4))
bd.0$Jahr[nchar(as.character(bd.0$Veranlagungsperiode))>4] <- bd.0$Jahr[nchar(as.character(bd.0$Veranlagungsperiode))>4] - 2
bd.0<-bd.0 %.% 
  filter(Einheit=="Total")
bd.0<-subset(bd.0,Jahr<1995 | Jahr >2002)
bd.0.long<-reshape(bd.0,
varying = c("gini_reink","gini_reinka"),
v.names = "Gini",
timevar = "inc_def",
times = c("Net income","Equivalised net income"),
direction ="long")
bdlong<-rbind(bd.0.long,bd.long)
@


<<With and without equivalence scale>>=
library(ggplot2)
number_ticks <- function(n) {function(limits) pretty(limits, n)}
ggplot(bdlong, aes(x=Jahr,y=Gini,shape=inc_def))+
  scale_y_continuous(limits=c(0.18,0.6))+
  scale_x_continuous(limits=c(1940,2012),breaks=number_ticks(10)) +
  geom_point(aes(shape=inc_def),size=3)+
  geom_line(data=bdlong,aes(linetype=inc_def))+
  theme_bw()+
  xlab("tax period")
@

\subsection{Measuring inequality}


\emph{Gini coefficients considering mean-tested benefits}

% Wollen wir das ?berhaupt machen?

\subsection{Measuring inequality}

% Zero-shares (alter Textbaustein)
%Estimation using population statistics (1945/46-1993/94) and official tax administration statistics (1995/96 and later) 
% Das allenfalls in der Methodensection machen?
% Vergleich mit der Dell-Reihe zu Non-fillers
% Überschneidungen gib es leider nicht 
% Interessant wäre es auch, zu sehen ob es Brüche in den Zeitreihen der Zahl der Steuerpflichtigen und jener ohne Besteuerung gibt.

\subsection{Population coverage}

\subsubsection{Normal versus special cases}

The FTA stopped to publicly report data for special cases after tax period 1993/94. 
For more recent periods however we can compare data from the 
BRUELHARTPROJEKT (wie nennen wir das?) to the FTA normal cases, as these data are 
identical but the BRÜLHART data include special cases. 
We will have a look at both, the 1993/94 period as the last period where both 
numbers were reported as well as 2009 where we compare data from the same source 
but using differnt data sheets.


%ABBILDUNGEN ZUM VERGLEICH NORMAL-/SONDERFÄLLE
<<specialcases9394, echo=FALSE,warning=FALSE>>=
library(dplyr, quietly=TRUE, warn.conflicts = FALSE)
library(ggplot2)
#library(reldist)
normal <- read.csv("../../data/ginis_und_perzentile_normal.csv",sep="\t")
#normal <- normal %.% select(-G_reink, -G_taxed, -ppop0, -G_steink0)
pooled <- read.csv("../../data/ginis_und_perzentile_beides.csv",sep="\t")
#special <- read.csv("data/ginis_und_perzentile_sonder.csv",segep="\t")
normal$case <- "normal case"
#special$case <- "special case"
pooled$case <- "pooled, normal and special cases"
d<-rbind(normal,pooled)
d<-d %.% 
  filter(kanton=="CH",steuerperiode==1993.5)

start <- which(names(d)=="p1")
end <- which(names(d)=="p99")
percentile <- c(1,5,10,20,25,30,40,50,60,70,75,80,90,95,99)
normal <- data.frame(t(d[1,start:end]),percentile,case="normal")
pooled <- data.frame(t(d[2,start:end]),percentile,case="pooled")
names(normal)[1]=c("inc")
names(pooled)[1]=c("inc")
percentiles <- rbind(normal,pooled)  
ggplot(percentiles, aes(x=percentile,y=inc,group=case,colour=case))+
	geom_line()+theme_bw()+
	scale_colour_grey()+
	xlab("Percentile")+ylab("taxable income")+
	ggtitle("Taxable incomes of normal and special cases 1993/94")+
  theme(legend.justification=c(0,1),legend.position=c(0, 1))


#plot relative distribution
rel <- data.frame(pooled$inc,normal$inc,pooled$percentile)
rel$change <- rel$pooled.inc/rel$normal.inc
ggplot(rel, aes(x=pooled.percentile,y=change))+
	geom_line()+theme_bw()+
	scale_colour_grey()+
	geom_line(linetype="dashed",aes(y=1),size=1)+
	xlab("Percentile")+ylab("taxable income")+
	ggtitle("Taxable incomes of normal versus special cases 1993/94")

#steuerpflichtige estv / stpf bruelhart
#1- (2762419 / 3268548)
@

<<specialcases09, echo=FALSE,warning=FALSE>>=
library(foreign)
library(ggplot2)
#library(reldist)
normal <- filter(read.csv("../../data/ginis_und_perzentile_normal.csv",sep="\t"),kanton=="CH",steuerperiode==2009)
start <- which(names(normal)=="p1")
end <- which(names(normal)=="p99")
percentile <- c(1,5,10,20,25,30,40,50,60,70,75,80,90,95,99)
normal <- data.frame(t(normal[1,start:end]),percentile)
names(normal)[1]=c("inc")

#bruelhart data
pooled <- filter(read.dta("../../data/data_Schweiz.dta"), Veranlagungsperiode==2009, Einheit=="Total")
start <- which(names(pooled)=="p1")
p95 <- which(names(pooled)=="p95")
end <- which(names(pooled)=="p99")
pooled <- data.frame(t(pooled[1,c(start:p95,end)]),percentile)
names(pooled)[1]=c("inc")
pooled$inc<-pooled$inc/1000 #adjust scale
normal$case <- "normal case"
pooled$case <- "pooled, normal and special cases"
percentiles <- rbind(normal,pooled)
ggplot(percentiles, aes(x=percentile,y=inc,group=case,colour=case))+
	geom_line()+theme_bw()+
	scale_colour_grey()+
	xlab("Percentile")+ylab("taxable income")+
	ggtitle("Taxable incomes of normal and special cases 2009")+
  theme(legend.justification=c(0,1),legend.position=c(0, 1))


#plot relative distribution
rel <- data.frame(pooled$inc,normal$inc,pooled$percentile)
rel$change <- rel$pooled.inc/rel$normal.inc
ggplot(rel, aes(x=pooled.percentile,y=change))+
	geom_line()+theme_bw()+
	geom_line(linetype="dashed",aes(y=1),size=2)+
	scale_colour_grey()+
	xlab("Percentile")+ylab("taxable income")+
	ggtitle("Taxable incomes of normal versus special cases 2009")

#steuerpflichtige estv / stpf bruelhart
#1- (3422210 / 3689063)
@


As we can see from figure~\ref{fig:specialcases93942} and \ref{fig:specialcases092}, special cases differ strongly 
from normal cases within the low and top percentiles. Within the tax period 1993/94 the fifth percentile of 
normal cases is 15.8\% higher than the fifth percentile of the combines data while the 95\% percentile of 
normal cases is even 0.7\% lower if one leaves out special cases. This indicates special cases are very 
different from normal cases as the share of special cases is only 15.5\%.\footnote{1993/94 there were 2.76 
million tax units defined as being normal cases compared to 0.51 million special cases.}
In 2009 the situation has the same pattern. The fifth percentile of normal cases has 11\% higher taxable 
income compared to data where special cases are included. The five percent top incomes are 4.9\% higher 
within all cases compared to normal cases only. The share of special cases however decreased 
to 7.2\%.\footnote{2009: 3.42 million normal cases, 0.27 million special cases}



\emph{Income measures with and without zeros}

taxable income with and without zeros

<<with_without_zeros,warning=FALSE>>=
dflong <- melt(df[,c("G_steink","G_steink0","kanton","steuerperiode")], id=c("kanton","steuerperiode"))
names(dflong)[3]<-"Type"
names(dflong)[4]<-"Gini"
levels(dflong$Type)<-c("without zeros","including zeros")
ggplot(dflong[dflong$kanton=="CH" & dflong$steuerperiode>=1995.5,], aes(x=steuerperiode,y=Gini,colour=Type))+geom_line(size=1)+theme_bw()+xlab("tax period")
ggplot(dflong[dflong$steuerperiode>=1995.5,], aes(x=steuerperiode,y=Gini,colour=Type))+geom_line()+facet_wrap(~kanton)+theme_bw()+xlab("tax period")+theme(axis.text.x = element_text(angle = 60, hjust = 1))

@

Including zeros leads to significantly higher gini coefficients. However we must keep in mind, that these might be artificially high values as we assume zero income for everyone in the zero group. We can conclude more from the graphic: the ratio between both measures seems to be quite constant although for aggregate Switzerland but there are minor deviations for multiple cantons as well as strong deviations for the cantons Geneva and Ticino. However the problems seem not to result from a shift in the zero-share over time but they are specific for the time-period when the tax system changed. 

\emph{comparison of tax-data and survey data distribution}

<<setup_data>>=
library(dplyr, quietly=TRUE, warn.conflicts = FALSE)
library(ggplot2)
library(reldist)
library(foreign)
# Get Brülhartdata for 2010
estv2010 <- read.csv("data/estv_normal_sonder_mitNuller_stE_2010.csv",sep=";")
###########################################
# Select percentiles for all cases (total)
estv2010.total<-estv2010[c(18:38),c(1,4)]
##
# Simulate individual data points
# cumulative probabilites
cum.p<-c(1,5,10,20,25,30,40,50,60,70,75,80,90,95,96,97,98,99,99.5,99.9,99.99)/100
# probabilities
prob<-c(cum.p[1],diff(cum.p), .01)
# extreme values beyond x (to sample)
#freq<-max(normal$anz_pflichtige)
freq<-3000
init<-0
fin<-(abs(max(estv2010.total$Total,na.rm=TRUE))+5)
# generate the sequence to take pairs from
ival<-c(init,estv2010.total$Total,fin)
len<-10000 # sequence of each pair
s<-sapply(2:length(ival),function(i){
  seq(ival[i-1],ival[i],length.out=len)
})
s<-sample(s,freq,prob=rep(prob, each=len),replace=T)
estv2010.total.ind<-data.frame(s)
names(estv2010.total.ind)[1]=c("inc")
estv2010.total.ind$inc<-estv2010.total.ind$inc/1000


# HABE - 2010 all cases 

#####################################################
#         ACHTUNG: Bisher ohne Gewichte!            #
#####################################################

habe0911<-read.table("P:/WGS/FBS/ISS/Projekte laufend/SNF Ungleichheit/Datengrundlagen/HABE/2009 bis 2011/HABE091011_Standard_130717UOe.txt", header=TRUE)
habe10<-habe0911 %.% 
  filter(Jahr08==2010)
habe10<-data.frame(habe10$VerfuegbaresEinkommen08)
names(habe10)<-"inc_habe"
habe10$inc_habe[habe10$inc_habe<0]<-0 # One values is -20'000
habe10$inc_habe<-habe10$inc_habe*12/1000 # transform from monthly income to income per year



# Probability density Function

density1 <- density(habe10$inc_habe)
plot(x = (density1$x), y = density1$y, type = "l",
     xlab = "Einkommen", ylab = "density",
     axes = FALSE,
     xlim = c(-70, 4600),
     ylim=c(0,1.103e-02))
title(main="FTA vs HBS income distribution",cex=0.6)
axis(side = 1)
axis(side = 2)
fig1legend <- list(x=c(2500,2500),y=c(1.103e-02,1.103e-02))
legend(fig1legend,lty=1:2,cex=0.5, bty="n",
       legend=c("HBS","FTA"))
density2 <- density(estv2010.total.ind$inc)
lines(x = (density2$x), y = density2$y, type = "l",lty=2)

# Relative Distribution

par(mfrow=c(1,3))
g10 <- reldist(y=estv2010.total.ind$inc, yo=habe10$inc_habe,
               smooth=0.4, ci=FALSE,
               yolabs=seq(-1,3,by=0.5),
               ylim=c(0.5,5.0),
               bar=TRUE, quiet=FALSE,
               xlab="Proportion of HBS Distribution")
title(main=paste("Overall realtive density"))
abline(h=1,lty=2)
g1A <- reldist(y=estv2010.total.ind$inc, yo=habe10$inc_habe,
               show="effect",
               bar=TRUE, quiet=FALSE,
               ylim=c(0.5,5.0), ylab="",
               smooth=0.4, ci=FALSE,
               yolabs=seq(-1,3,by=0.5),
               xlab="Proportion of HBS Distribution")
title(main=paste("Effect of Median shift"))
abline(h=1,lty=2)
gA0 <- reldist(y=estv2010.total.ind$inc, yo=habe10$inc_habe,
               smooth=0.4, ci=FALSE,
               show="residual",
               bar=TRUE, quiet=FALSE,
               ylim=c(0.5,5.0), ylab="",
               yolabs=seq(-1,3,by=0.5),
               xlab="Proportion of HBS Distribution")
title(main=paste("Effect of different shape"))
abline(h=1,lty=2)
par(mfrow=c(1,1))

########################
# Separate comparison for unmarried

# Select married - ESTV

estv2010.married<-estv2010[c(18:38),c(1,2)]
names(estv2010.married)[2]=c("married")
##
# Simulate individual data points
# Percentile-Plot (descriptive  purpose)
# cumulative probabilites
cum.p<-c(1,5,10,20,25,30,40,50,60,70,75,80,90,95,96,97,98,99,99.5,99.9,99.99)/100
# probabilities
prob<-c(cum.p[1],diff(cum.p), .01)
# extreme values beyond x (to sample)
#freq<-max(normal$anz_pflichtige)
freq<-3000
init<-0
fin<-(abs(max(estv2010.married$married,na.rm=TRUE))+5)
# generate the sequence to take pairs from
ival<-c(init,estv2010.married$married,fin)
len<-10000 # sequence of each pair
s<-sapply(2:length(ival),function(i){
  seq(ival[i-1],ival[i],length.out=len)
})
s<-sample(s,freq,prob=rep(prob, each=len),replace=T)
estv2010.married.ind<-data.frame(s)
names(estv2010.married.ind)[1]=c("inc")
estv2010.married.ind$inc<-estv2010.married.ind$inc/1000




# Select married - HABE

habe0911<-read.table("P:/WGS/FBS/ISS/Projekte laufend/SNF Ungleichheit/Datengrundlagen/HABE/2009 bis 2011/HABE091011_Standard_130717UOe.txt", header=TRUE)
habe10<-habe0911 %.% 
  filter(Jahr08==2010)
habe10.married<-habe0911 %.% 
  filter(Familientyp08>130,Jahr08==2010)
habe10.married<-data.frame(habe10.married$VerfuegbaresEinkommen08)
names(habe10.married)<-"inc_habe"
habe10.married$inc_habe[habe10.married$inc_habe<0]<-0 # One values is -20'000
habe10.married$inc_habe<-habe10.married$inc_habe*12/1000 # transform from monthly income to income per year

# Probability Density Function

density1 <- density(habe10.married$inc_habe)
plot(x = (density1$x), y = density1$y, type = "l",
     xlab = "Einkommen", ylab = "density",
     axes = FALSE,
     xlim = c(-257, 8000),
     ylim=c(0,0.0101390))
title(main="FTA vs HBS income distribution",cex=0.6)
axis(side = 1)
axis(side = 2)
fig1legend <- list(x=c(2500,2500),y=c(0.0101390,0.0101390))
legend(fig1legend,lty=1:2,cex=0.5, bty="n",
       legend=c("HBS","FTA"))
density2 <- density(estv2010.married.ind$inc)
lines(x = (density2$x), y = density2$y, type = "l",lty=2)

# Relative Distribution

par(mfrow=c(1,3))
g10 <- reldist(y=estv2010.married.ind$inc, yo=habe10.married$inc_habe,
               smooth=0.4, ci=FALSE,
               yolabs=seq(-1,3,by=0.5),
               ylim=c(0.5,5.0),
               bar=TRUE, quiet=FALSE,
               xlab="Proportion of HBS Distribution")
title(main=paste("Overall realtive density"))
abline(h=1,lty=2)
g1A <- reldist(y=estv2010.married.ind$inc, yo=habe10.married$inc_habe,
               show="effect",
               bar=TRUE, quiet=FALSE,
               ylim=c(0.5,5.0), ylab="",
               smooth=0.4, ci=FALSE,
               yolabs=seq(-1,3,by=0.5),
               xlab="Proportion of HBS Distribution")
title(main=paste("Effect of Median shift"))
abline(h=1,lty=2)
gA0 <- reldist(y=estv2010.married.ind$inc, yo=habe10.married$inc_habe,
               smooth=0.4, ci=FALSE,
               show="residual",
               bar=TRUE, quiet=FALSE,
               ylim=c(0.5,5.0), ylab="",
               yolabs=seq(-1,3,by=0.5),
               xlab="Proportion of HBS Distribution")
title(main=paste("Effect of different shape"))
abline(h=1,lty=2)
par(mfrow=c(1,1))


#################
# Separate comparison for unmaried


##
# Unmarried ESTV

estv2010.unmarried<-estv2010[c(18:38),c(1,3)]
names(estv2010.unmarried)[2]=c("unmarried")
##
# Simulate individual data points
# Percentile-Plot (descriptive  purpose)
# cumulative probabilites
cum.p<-c(1,5,10,20,25,30,40,50,60,70,75,80,90,95,96,97,98,99,99.5,99.9,99.99)/100
# probabilities
prob<-c(cum.p[1],diff(cum.p), .01)
# extreme values beyond x (to sample)
#freq<-max(normal$anz_pflichtige)
freq<-3000
init<-0
fin<-(abs(max(estv2010.unmarried$unmarried,na.rm=TRUE))+5)
# generate the sequence to take pairs from
ival<-c(init,estv2010.unmarried$unmarried,fin)
len<-10000 # sequence of each pair
s<-sapply(2:length(ival),function(i){
  seq(ival[i-1],ival[i],length.out=len)
})
s<-sample(s,freq,prob=rep(prob, each=len),replace=T)
estv2010.unmarried.ind<-data.frame(s)
names(estv2010.unmarried.ind)[1]=c("inc")
estv2010.unmarried.ind$inc<-estv2010.unmarried.ind$inc/1000


# Select unmarried - HABE

habe0911<-read.table("P:/WGS/FBS/ISS/Projekte laufend/SNF Ungleichheit/Datengrundlagen/HABE/2009 bis 2011/HABE091011_Standard_130717UOe.txt", header=TRUE)
habe10<-habe0911 %.% 
  filter(Jahr08==2010)
habe10.unmarried<-habe0911 %.% 
  filter(Familientyp08<140,Jahr08==2010)
habe10.unmarried<-data.frame(habe10.unmarried$VerfuegbaresEinkommen08)
names(habe10.unmarried)<-"inc_habe"
habe10.unmarried$inc_habe[habe10.unmarried$inc_habe<0]<-0 # One values is -20'000
habe10.unmarried$inc_habe<-habe10.unmarried$inc_habe*12/1000 # transform from monthly income to income per year


# Probability Density Function

density1 <- density(habe10.unmarried$inc_habe)
plot(x = (density1$x), y = density1$y, type = "l",
     xlab = "Einkommen", ylab = "density",
     axes = FALSE,
     xlim = c(-50, 2500),
     ylim=c(0,1.764e-02))
title(main="FTA vs HBS income distribution",cex=0.6)
axis(side = 1)
axis(side = 2)
fig1legend <- list(x=c(1200,1200),y=c(1.764e-02,1.764e-02))
legend(fig1legend,lty=1:2,cex=0.5, bty="n",
       legend=c("HBS","FTA"))
density2 <- density(estv2010.unmarried.ind$inc)
lines(x = (density2$x), y = density2$y, type = "l",lty=2)

# Relative Distribution

par(mfrow=c(1,3))
g10 <- reldist(y=estv2010.unmarried.ind$inc, yo=habe10.unmarried$inc_habe,
               smooth=0.4, ci=FALSE,
               yolabs=seq(-1,3,by=0.5),
               ylim=c(0.5,5.0),
               bar=TRUE, quiet=FALSE,
               xlab="Proportion of HBS Distribution")
title(main=paste("Overall realtive density"))
abline(h=1,lty=2)
g1A <- reldist(y=estv2010.unmarried.ind$inc, yo=habe10.unmarried$inc_habe,
               show="effect",
               bar=TRUE, quiet=FALSE,
               ylim=c(0.5,5.0), ylab="",
               smooth=0.4, ci=FALSE,
               yolabs=seq(-1,3,by=0.5),
               xlab="Proportion of HBS Distribution")
title(main=paste("Effect of Median shift"))
abline(h=1,lty=2)
gA0 <- reldist(y=estv2010.unmarried.ind$inc, yo=habe10.unmarried$inc_habe,
               smooth=0.4, ci=FALSE,
               show="residual",
               bar=TRUE, quiet=FALSE,
               ylim=c(0.5,5.0), ylab="",
               yolabs=seq(-1,3,by=0.5),
               xlab="Proportion of HBS Distribution")
title(main=paste("Effect of different shape"))
abline(h=1,lty=2)
par(mfrow=c(1,1))
@


\subsection{Intertemporal comparison}



